<Project>

  <PropertyGroup>
    <GenerateSpecFlowCodeFilesDependsOn>
      EnsureLegacySpecFlowCodeGenerationIsDisabled;
      DetermineSpecFlowGeneratedCodeLocation;
      $(GenerateSpecFlowCodeFilesDependsOn)
    </GenerateSpecFlowCodeFilesDependsOn>
    <CleanSpecFlowGeneratedCodeFilesDependsOn>
      DetermineSpecFlowGeneratedCodeLocation;
      $(CleanSpecFlowGeneratedCodeFilesDependsOn)
    </CleanSpecFlowGeneratedCodeFilesDependsOn>
  </PropertyGroup>
  
  <ItemGroup>
    <SpecFlowFeature Include="**/*.feature" />
    <SpecFlowFeature Include="**/*.feature.xls" />
  </ItemGroup>

  <!--
  Determines the location at which to write generated code files.
  -->
  <Target
    Name="DetermineSpecFlowGeneratedCodeLocation"
    Condition="'$(SpecFlowGeneratedCodePath)' == ''">

    <PropertyGroup>
      <SpecFlowGeneratedCodePath>$(IntermediateOutputPath)</SpecFlowGeneratedCodePath>
    </PropertyGroup>
    
  </Target>
  
  <!-- 
  Processes the SpecFlow .feature files and generates the source code to be included in the compile phase. 
  -->
  <Target
    Name="GenerateSpecFlowCodeFiles"
    BeforeTargets="BeforeCompile"
    DependsOnTargets="$(GenerateSpecFlowCodeFilesDependsOn)"
    Inputs="@(SpecFlowFeature)"
    Outputs="@(SpecFlowFeature->'$(SpecFlowGeneratedCodePath)%(Identity)$(DefaultLanguageSourceExtension)')">
        
    <GenerateFeatureFileCodeBehindTask
      ProjectPath="$(MSBuildProjectFullPath)"
      OutputPath="$(SpecFlowGeneratedCodePath)"
      FeatureFiles="@(SpecFlowFeature)"
      RootNamespace="$(RootNamespace)"
      GeneratorPlugins="@(SpecFlowGeneratorPlugins)" />
   
    <!-- Include the generated files as compile input. -->
    <ItemGroup>
      <Compile Include="@(SpecFlowFeature->'$(SpecFlowGeneratedCodePath)%(Identity)$(DefaultLanguageSourceExtension)')" />
    </ItemGroup>
  
  </Target>
  
  <!-- 
  Cleans up any intermediary files which may have been generated by the SpecFlow generation process. 
  -->
  <Target
    Name="CleanSpecFlowGeneratedCodeFiles"
    DependsOnTargets="$(CleanSpecFlowGeneratedCodeFilesDependsOn)"
    BeforeTargets="Clean">
    
    <ItemGroup>
      <SpecFlowGeneratedCodeFile Include="$(SpecFlowGeneratedCodePath)**/*.feature$(DefaultLanguageSourceExtension)" />
      <SpecFlowGeneratedCodeFile Include="$(SpecFlowGeneratedCodePath)**/*.feature.xls$(DefaultLanguageSourceExtension)" />
    </ItemGroup>
    
    <Delete Files="@(SpecFlowGeneratedCodeFile)" ContinueOnError="true" />
  
  </Target>

  <!--
  Ensures that none of the feature files in the project have the code-behind generation tool present.
  -->
  <Target Name="EnsureLegacySpecFlowCodeGenerationIsDisabled">
    <Error
      Text="SpecFlow designer codebehind generation is not compatible with MSBuild codebehind generation. The custom tool must be removed from the file. See http://www.specflow.org/documentation/Generate-Tests-from-MsBuild"
      File="@(SpecFlowFeature)"
      Condition="'%(None.Generator)' == 'SpecFlowSingleFileGenerator'"/>
  </Target>

</Project>