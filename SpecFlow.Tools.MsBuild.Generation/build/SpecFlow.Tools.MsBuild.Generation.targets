<Project>

  <Import Project="SpecFlow.Tools.MsBuild.Generation.props" Condition="'$(_SpecFlowPropsImported)'==''"/>

  <PropertyGroup>
    <_SpecFlow_Tools_MsBuild_Generation_Imported>true</_SpecFlow_Tools_MsBuild_Generation_Imported>
  </PropertyGroup>

  <PropertyGroup Condition="'$(BuildServerMode)' == ''">
    <BuildServerMode Condition="'$(BuildingInsideVisualStudio)'=='true'">false</BuildServerMode>
    <BuildServerMode Condition="'$(BuildingInsideVisualStudio)'!='true'">true</BuildServerMode>
  </PropertyGroup>

  <PropertyGroup>
    <BuildDependsOn>
      BeforeGenerateSpecFlowCodeBehindFiles;
      GenerateSpecFlowCodeBehindFiles;
      AfterGenerateSpecFlowCodeBehindFiles;
      $(BuildDependsOn)
    </BuildDependsOn>
    <CleanDependsOn>
      CleanGeneratedSpecFlowCodeBehindFiles;
      $(CleanDependsOn)
    </CleanDependsOn>
    <RebuildDependsOn>
      SwitchToForceGenerate;
      $(RebuildDependsOn)
    </RebuildDependsOn>
  </PropertyGroup>

  <Target Name="SwitchToForceGenerate">
    <PropertyGroup>
      <ForceGeneration>true</ForceGeneration>
    </PropertyGroup>
  </Target>

  <Target Name="GenerateSpecFlowCodeBehindFiles"
          DependsOnTargets="BeforeGenerateSpecFlowCodeBehindFiles">

    <Message Text="SpecFlowFeatureFiles: @(SpecFlowFeatureFiles)" Importance="high" Condition="'$(VerboseOutput)' == 'true'" />

    <Error
      Text="SpecFlow designer codebehind generation is not compatible with MSBuild codebehind generation. The custom tool must be removed from the file. See https://www.specflow.org/documentation/Generate-Tests-from-MsBuild"
      File="@(None)"
      Condition="%(None.Extension) == '.feature' AND %(None.Generator) == 'SpecFlowSingleFileGenerator'"/>
      
    <PropertyGroup Condition="'$(TargetFrameworkVersion)' != ''">
      <SpecFlow_TargetFramework>$(TargetFrameworkVersion)</SpecFlow_TargetFramework>
    </PropertyGroup>
    <PropertyGroup Condition="'$(TargetFramework)' != ''">
      <SpecFlow_TargetFramework>$(TargetFramework)</SpecFlow_TargetFramework>
      <SpecFlow_TargetFrameworks>$(TargetFramework)</SpecFlow_TargetFrameworks>
    </PropertyGroup>
    <PropertyGroup Condition="'$(TargetFrameworks)' != ''">
      <SpecFlow_TargetFrameworks>$(TargetFrameworks)</SpecFlow_TargetFrameworks>
    </PropertyGroup>

    <GenerateFeatureFileCodeBehindTask
      ProjectPath="$(MSBuildProjectFullPath)"
      OutputPath="$(SpecFlowCodeBehindOutputPath)"
      FeatureFiles="@(SpecFlowFeatureFiles)"
      RootNamespace="$(RootNamespace)"
      GeneratorPlugins="@(SpecFlowGeneratorPlugins)" 
      
      MSBuildVersion="$(MSBuildVersion)"
      AssemblyName="$(AssemblyName)"
      TargetFrameworks="$(SpecFlow_TargetFrameworks)"
      TargetFramework="$(SpecFlow_TargetFramework)"
      ProjectGuid="$(ProjectGuid)"
      >

      <Output TaskParameter="GeneratedFiles" ItemName="SpecFlowGeneratedFiles" />
    </GenerateFeatureFileCodeBehindTask>

    <Message Text="SpecFlowGeneratedFiles: %(SpecFlowGeneratedFiles.Identity)" Importance="high" Condition="'$(VerboseOutput)' == 'true'" />

    <!-- Include generated files for compilation. -->
    <ItemGroup>
      <Compile Include="@(SpecFlowFeatureFiles->'$(SpecFlowCodeBehindOutputPath)%(RelativeDir)%(Filename)%(Extension)$(DefaultLanguageSourceExtension)')" />
    </ItemGroup>
  </Target>

  <Target Name="BeforeGenerateSpecFlowCodeBehindFiles">

  </Target>

  <Target Name="AfterGenerateSpecFlowCodeBehindFiles">
    <!-- include any generated SpecFlow files in the compilation of the project if not included yet -->
    <ItemGroup>
      <EmbeddedResource Include="@(SpecFlowFeatureFiles)" />
    </ItemGroup>
  </Target>

  
  <Target Name="CleanGeneratedSpecFlowCodeBehindFiles">
    <Delete Files="$(SpecFlowCodeBehindOutputPath)**/*.cs" ContinueOnError="true" />
  </Target>
</Project>